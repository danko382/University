заголовк системное программирование

Основная программа оформляется как внешняя проце

подпрограмма - вспомогательный алгоритм, к которому возможно
многократное обращение. В ассемблере представлена только в
виде поцедуры, которая оформляется так же как и основная программа
с помощью директив proc и endp

шаблон (слайд)

Описание процедуры может размещаться в любом месте программы, но так,
чтобы управление на неё попадало с помощью команды call,
но можно и с помощью передачи управления (так делать не стоит),
поэтому подпрограммы обысно размещают после основной программы
или перед основной программой, а если подпрограмм много,
то можно их собрать в отдельный кодовый сегмент, но
тогда для обращения к ним нужно будет использовать директивы
public и extendent

пример определения процедур(слайд)

После имени в директиве proc ":" не ставится, но используется
это имя как метка первой команды подпрограммы.

Метки в подпрограммах могут быть локализованными или не локализованными,
в зависимости от типа компилятора (в tasm они не локализованы, в 
masm и pasm локализованы), но основная проблема и задача при 
использовании подпрограмм - это передача параметров.
Передавать их можно по значению, по ссылке, по возвращаемому значению,
по результату и отложенным вычислением.

Параметры можно передавать через регистры, можно передавать через
глобальные переменные, через стек, через потоки кода и через блоки
данных.

Использование решистров для фактических параметров - наиболее
простой способ. Вызывающая программа, перед обращением к подпрограмме
загружает фактический параметр в некоторые регистры, а подпрограмма
извлекает их оттуда и использует, такой способ реализуется
в некоторых функциях oc и bios, но регистров мало, и, если их 
недостаточно, то тогда можно пометить параметр в глобальную переменную,
у уоторой подпрограмма будет обращаться. Такой способ не эффективен,
так как в этом случае нельзя реализовать рекурсию и иногда повторное
обращение к программе. 

Передача параметров через стек заключается
в том, что перед обращением к подпрограмме, фактические параметры 
загружаются в стек, подпрограмма извлекает их и использует. Именно 
такой способ используется в языках высокого уровня.

Передача параметров в потоке кода заключается в том, что параметры
располагаются сразу за командой call и подпрограмма, чтобы
их использовать должна обратиться к адресу возврата, который
записывается в стек автоматически командой call, но теперь,
чтобы возвратиться из подпрограммы, перед выходом из подпрограммы
необходимо изменить адрес возврата, на адрес команды, следующий
за данными. Этот способ сложнее, чем передача через регистры,
глобальную переменную или стек, но примерно так же как и в блоке
параметров. 

В блоке данных фактические параметры размещаются в некоторой
области памяти, обычно это сегмент данных. Адрес начала этого
блока передаётся процедуре любым способом: через
регистры, глобальную переменную, стек, потоки кода или
даже в другом блоке параметров, и такой способ часто используется
в функциях операционной системы или bios, например, поиск данных
DTA или загрузка и исполнение программы EPB.

При передаче параметров по значению подпрограмма передаётся
значение фактического параметра, это значение копируется в
подпрограмме и используется, следовательно, изменить это
значение подпрограмма не может. Такой способ используется для передачи
параметров небольшого размера.

Пример (слайд)

Все числа знаковые размером с слово, используем простейший способ
передачи парамтров через регистры, то есть загружает параметры в
Ax и Bx и результат записываем в AX.

процедура (слайд)

фрагмент вызывающей программы (слайд)

Передача параметров по адресу

Оформим как процедуру вычисления x = x div 16

Параметр 1, он входной и выходной и должен содержаться в
какой-то ячейке памяти, а если мы хоти несколько раз 
обратиться к этой процедуре, то нужно иметь несколько адресов
параметров. Можно использовать регистры (чаще всего BX, BP, SI, DI).
Пусть мы передаём через регистр BX, запишем вначале фрагмент вызывающей
программы

пример (слайд)

Процедура может выглядеть так (слайд)

Мы использовали команду сдвига вместо деления, которая выполнится 
значительно быстрее (сдвиг на 4 разряда вправо эквивадлентен делению
на 16). Процедуру начали с сохранения CX, так как мы использкуем часть
регистра в подпрограмме, а возможно, что CX используется в вызывающей 
подпрограмме, поэтому сначала сохранили его, а после ывстановили.
Поскольку регистров мало + их использует и вызывающая программа и 
подпрограмма, то это значит, что при входе в процедуру, сохранить
содержимое регистров в стеке, а перед выходом их восстановить.
Но, конечно, если результат хранится в регистре его не надо 
сохранять и восстанавливать. Именно для этого и существуют pusha и
popa.

Передача параметров по ссылке в блоке параметров

Массив - много параметров. Адрес начала массива передаём через
регистр и посмотрисъм такой пример. Пусть для двух байтовых массивов
X и Y, один на 100, другой на 50 элементов и нужно
вычислить сумму максимумов и загрузить в регистр

Пример (слайд)

Напишем процедуру поиска максимального в одномерном массиве, если
элементы массива нумеруются с нуля. (слайд)

Передача парметров через стек - это универсальный способ,
можно использоватб при любом количестве параметров, но способ
сложнее чем через регистры.

Пусть у нас есть подпрограмма у которой есть k параметров
PP($a_1, \dots, a_k$) размером в слово и сохраняем их в стеке последовательно
слева направо.

Обращение к процедуре (слайд)

Содержимое стека (слайд)

Чтобы обратиться к параметра $a_1, \dots, a_k$ мы можем
импользовать регистр BP, но вначале ему нужно присвоить значение SP,
но вполне вероятно BP используется в вызывающей программе, поэтому его
нужно предварительно сохранить в процедуре.

То есть входные действия будут такими:

пример(слайд)

стек будет выглядеть так (слайд)

Чтобы обратиться к k-тому параметру можно использовать выражение (слайд)

Затем реализуем программы для вспомогательного алгоритма.

Выходные действия в процедуре должны заключаться в восстановлении регистра
BP и очистка стека от параметров.

образец (слайд)

Команда ret n - это количество освобождаемых байтов в стеке
Команда ret вначале считывает адрес возврата, а затем удаляет из 
стека n байтов.

Очистку стека от параметров можно выполнять в процедуре (подпрограмме),
а можно выполнять после выхода из подпрограммы, после выхода из подпрограммы
можно это сделать так 

add SP, 2*k

Но если очистку делать в процедуре, то исходный текст основной программы
будет меньше, а если параметров много, то для простого использования 
фактических  параметров можно использовать при входе в процедуру
использовать директиву equ, чтобы присвоть символические имена параметрам
вместо выражений

пример (слайд)

Пример передачи парметров через стек

Пусть наша процедура (очищает) заполняет нулями массив, а вызывающая 
программа обращается к этой процедуре для очистки двух массивов
X и Y по 100 и 50 элементов соответственно. Параметры будем передавать
через стек, размер можно передавать по значению, а имя массива по адресу
(по ссылке), потому что этот параметр входной и выходной параметр.

Процедура (слайд)

восстановление регистров и выходные действия (слайд)

Передача по значению пример (слайд)

передача по ссылке пример (слайд)

Передача параметров по возвращаемому значению объединяет передачу по ссылке
и по значению: процедуре передаётся адресс переменной, она делает локальную
копию этого параметра, работает с этой копией, а в конце записывает эту копию

(слайд)

Передача параметра по имени макроопределения (слайд)

Обращение к ПП может быть таким (слайд)

Передача параметров отложенным вычислением. В этом случае наша процедура
получает адресс подпрограммы, вычисляющая значения фактических параметров
для неё. Такой механизм используется чаща в ИИ и ОС.

Заголовок Использование локальных параметров.